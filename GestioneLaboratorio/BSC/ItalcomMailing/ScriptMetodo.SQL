-- script Metodo


IF OBJECT_ID ('dbo.VistaRelazioniCFVdaDocZSI_BSC') IS NOT NULL
	DROP VIEW dbo.VistaRelazioniCFVdaDocZSI_BSC
GO

CREATE VIEW [dbo].[VistaRelazioniCFVdaDocZSI_BSC] AS 
SELECT w.CODCLIFOR
	, W.CODART
	, isnull(isnull(V1.ARTICOLOBSC,X.ARTICOLOBSC),w.codart) AS ARTICOLOBSC
FROM 
	(	select codclifor,codart
		from  TESTEDOCUMENTI t JOIN RIGHEDOCUMENTI r ON t.PROGRESSIVO = r.IDTESTA
		WHERE t.CODCLIFOR LIKE 'C%'
		AND codart <> ''
		GROUP BY codclifor,codart ) AS w 
	LEFT OUTER JOIN  VISTARELAZIONICFV V1 ON v1.codclifor = W.codclifor AND v1.CodArticolo = w.codart 
	LEFT OUTER JOIN VISTARELAZIONICFV X ON X.CODCLIFOR = 'C' AND X.CodArticolo = w.codart
GO

GRANT DELETE ON dbo.VistaRelazioniCFVdaDocZSI_BSC TO Metodo98
GO
GRANT INSERT ON dbo.VistaRelazioniCFVdaDocZSI_BSC TO Metodo98
GO
GRANT REFERENCES ON dbo.VistaRelazioniCFVdaDocZSI_BSC TO Metodo98
GO
GRANT SELECT ON dbo.VistaRelazioniCFVdaDocZSI_BSC TO Metodo98
GO
GRANT UPDATE ON dbo.VistaRelazioniCFVdaDocZSI_BSC TO Metodo98
GO





UPDATE dbo.TABNAZIONI
SET DESCRIZIONELINGUA9 = 'EN_'


UPDATE dbo.TABNAZIONI
SET DESCRIZIONELINGUA9 = 'PT_'
WHERE CODICE = 6
GO

UPDATE dbo.TABNAZIONI
SET DESCRIZIONELINGUA9 = 'PT_'
WHERE CODICE = 13
GO

UPDATE dbo.TABNAZIONI
SET DESCRIZIONELINGUA9 = 'PL_'
WHERE CODICE = 16
GO

UPDATE dbo.TABNAZIONI
SET DESCRIZIONELINGUA9 = 'IT_'
WHERE CODICE = 0
GO

UPDATE dbo.TABNAZIONI
SET DESCRIZIONELINGUA9 = 'FR_'
WHERE CODICE = 3
GO

UPDATE dbo.TABNAZIONI
SET DESCRIZIONELINGUA9 = 'ES_'
WHERE CODICE = 5
GO

UPDATE dbo.TABNAZIONI
SET DESCRIZIONELINGUA9 = 'EN_'
WHERE CODICE = 11
GO

UPDATE dbo.TABNAZIONI
SET DESCRIZIONELINGUA9 = 'EN_'
WHERE CODICE = 29
GO

UPDATE dbo.TABNAZIONI
SET DESCRIZIONELINGUA9 = 'EL_'
WHERE CODICE = 7
GO

UPDATE dbo.TABNAZIONI
SET DESCRIZIONELINGUA9 = 'DE_'
WHERE CODICE = 1
GO

UPDATE dbo.TABNAZIONI
SET DESCRIZIONELINGUA9 = 'BL_'
WHERE CODICE = 22
GO


SELECT * FROM tabnazioni






IF OBJECT_ID ('dbo.fn_GetEMAILCONTATTICLIENTE') IS NOT NULL
	DROP FUNCTION dbo.fn_GetEMAILCONTATTICLIENTE
GO

create function [dbo].[fn_GetEMAILCONTATTICLIENTE](@RIFCONTO VARCHAR(7)) returns varchar(8000) as begin
	declare @Str varchar(8000)
	
	set @Str = ''
	
	select @Str = @Str + (case @Str when '' then '' else ';' end) + R.EMAIL
	from TABELLAPERSONALE R 
	WHERE R.RIFCODCONTO = @RIFCONTO AND  R.CODRUOLO IN (1, 2, 4)
	group by R.EMAIL

	IF @str = ''
	BEGIN
		-- imposto a 0 altrimenti la pubblicazione va in errore 
		SET @str = ''
	END
	
	IF (RIGHT(@str, 1)<> ';')
	BEGIN
		SET @str = @str + ';'
	END 

	return @Str
end
GO

GRANT EXECUTE ON dbo.fn_GetEMAILCONTATTICLIENTE TO Metodo98
GO
GRANT REFERENCES ON dbo.fn_GetEMAILCONTATTICLIENTE TO Metodo98
GO






IF OBJECT_ID ('dbo.VistaRelazioniCFVdaDocZSI_BSC') IS NOT NULL
	DROP VIEW dbo.VistaRelazioniCFVdaDocZSI_BSC
GO

CREATE VIEW [dbo].[VistaRelazioniCFVdaDocZSI_BSC] AS 
SELECT w.CODCLIFOR
	, W.CODART
	, isnull(isnull(V1.ARTICOLOBSC,X.ARTICOLOBSC),w.codart) AS ARTICOLOBSC
FROM 
	(	select codclifor,codart
		from  TESTEDOCUMENTI t JOIN RIGHEDOCUMENTI r ON t.PROGRESSIVO = r.IDTESTA
		WHERE t.CODCLIFOR LIKE 'C%'
			 AND t.datadoc >= CAST(CAST(YEAR(GETDATE())-2 AS VARCHAR) + '0101' AS DATETIME)
			 AND t.TIPODOC IN (SELECT codice FROM PARAMETRIDOC WHERE CLIFOR = 'C' AND TIPO = 'B' AND CODICE <> 'DCG' AND LEFT(CODICE, 1 ) = 'D')
			AND codart <> ''
		GROUP BY codclifor,codart
		 ) AS w 
	LEFT OUTER JOIN  VISTARELAZIONICFV V1 ON v1.codclifor = W.codclifor AND v1.CodArticolo = w.codart 
	LEFT OUTER JOIN VISTARELAZIONICFV X ON X.CODCLIFOR = 'C' AND X.CodArticolo = w.codart
GO

GRANT DELETE ON dbo.VistaRelazioniCFVdaDocZSI_BSC TO Metodo98
GO
GRANT INSERT ON dbo.VistaRelazioniCFVdaDocZSI_BSC TO Metodo98
GO
GRANT REFERENCES ON dbo.VistaRelazioniCFVdaDocZSI_BSC TO Metodo98
GO
GRANT SELECT ON dbo.VistaRelazioniCFVdaDocZSI_BSC TO Metodo98
GO
GRANT UPDATE ON dbo.VistaRelazioniCFVdaDocZSI_BSC TO Metodo98
GO

--SELECT * FROM VistaRelazioniCFVdaDocZSI_BSC




IF OBJECT_ID ('dbo.ITA_SP_UPDATE_REGISTRONOTIFICHEBSC') IS NOT NULL
	DROP PROCEDURE dbo.ITA_SP_UPDATE_REGISTRONOTIFICHEBSC
GO

CREATE PROCEDURE [dbo].[ITA_SP_UPDATE_REGISTRONOTIFICHEBSC]

AS

BEGIN

SET NOCOUNT ON

	INSERT INTO dbo.ITA_TABREGISTRONOTIFICHEBSC (CODCLIFOR, CODART, ARTICOLOBSC, CODLINGUA
	, IDOBJECT_CLI, IDOBJECT_ART, IDOBJECT_BOL, IDOBJECT_SCH
	, RAGIONESOCIALE, DESCRIZIONEARTICOLO
	, EMAIL_CLIENTE, EMAIL_AGENTE
	, IDDOC_BOL
	, FILENAME_BOL, CODICEDOCUMENTO_BOL, DATAULTIMOINVIO_BOL
	, IDDOC_SCH
	, FILENAME_SCH, CODICEDOCUMENTO_SCH, DATAULTIMOINVIO_SCH
	, STATOINVIO_BOL, STATOINVIO_SCH)
 	SELECT CODCLIFOR, CODART, ARTICOLOBSC
		, '' AS CODLINGUA
		, 0 AS IDOBJECT_CLI
		, 0 AS IDOBJECT_ART
		, 0 AS IDOBJECT_BOL
		, 0 AS IDOBJECT_SCH
		, '' AS RAGIONESOCIALE
		, '' AS DESCRIZIONEARTICOLO
		, '' AS EMAIL_CLIENTE
		, '' AS EMAIL_AGENTE
		, 0 AS IDDOC_BOL
		, '' AS FILENAME_BOL
		, '' AS CODICEDOCUMENTO_BOL
		, NULL AS DATAULTIMOINVIO_BOL		
		, 0 AS IDDOC_SCH
		, '' AS FILENAME_SCH
		, '' AS CODICEDOCUMENTO_SCH
		, NULL AS DATAULTIMOINVIO_SCH
		, 0 AS STATOINVIO_BOL
		, 0 AS STATOINVIO_SCH
	FROM VistaRelazioniCFVdaDocZSI_BSC
	WHERE NOT EXISTS(SELECT 1 FROM ITA_TABREGISTRONOTIFICHEBSC X WHERE X.CODCLIFOR = VistaRelazioniCFVdaDocZSI_BSC.CODCLIFOR
	AND X.CODART = VistaRelazioniCFVdaDocZSI_BSC.CODART
	)

	UPDATE 
		ITA_TABREGISTRONOTIFICHEBSC
	SET 
		IDOBJECT_CLI = isnull((SELECT TOP 1 i.IdPubblicazioneKnos FROM ITA_ARCHIVIO_CLIFOR i WHERE i.CodConto = CODCLIFOR), 0)

	UPDATE 
		ITA_TABREGISTRONOTIFICHEBSC
	SET 
		IDOBJECT_ART = isnull((SELECT TOP 1 i.IdPubblicazioneKnos FROM ITA_ARCHIVIO_ARTICOLI i WHERE i.CODICE = ARTICOLOBSC), 0)

	UPDATE 
		ITA_TABREGISTRONOTIFICHEBSC
	SET 
		DESCRIZIONEARTICOLO = (SELECT TOP 1 a.DESCRIZIONE FROM ANAGRAFICAARTICOLI A WHERE CODICE = ARTICOLOBSC)
	
	
	UPDATE  T 
	SET 
		T.RAGIONESOCIALE = a.DSCCONTO1,
		T.CODLINGUA = ISNULL(TN.DESCRIZIONELINGUA9, 'EN_')
	FROM 
		ITA_TABREGISTRONOTIFICHEBSC T JOIN ANAGRAFICACF A ON A.CODCONTO = T.CODCLIFOR
		JOIN TABNAZIONI TN ON A.CODNAZIONE = TN.CODICE
		
		
	UPDATE T 
	SET 
		T.IDDOC_BOL = ISNULL(bol.IDDOC, 0)
		, T.FILENAME_BOL = bol.FILENAME
		, T.IDOBJECT_BOL = bol.IDOBJECT_BOL
	FROM
		ITA_TABREGISTRONOTIFICHEBSC T JOIN Knos_ZSI.DBO.Metodo_View_LinkageBollettini bol 
		ON bol.IDOBJECT_ART = T.IDOBJECT_ART and bol.IDOBJECT_CLIFOR = 38750
	--WHERE
	--	t.IDDOC_BOL = 0
		
	-- schede tecniche
	UPDATE T 
	SET 
		T.IDDOC_SCH = ISNULL(bol.IDDOC, 0)
		, T.FILENAME_SCH = bol.FILENAME
		, T.IDOBJECT_SCH = bol.IDOBJECT_SCH
	FROM
		ITA_TABREGISTRONOTIFICHEBSC T JOIN Knos_ZSI.DBO.[Metodo_View_LinkageSchedeTecniche] bol 
		ON bol.IDOBJECT_ART = T.IDOBJECT_ART and bol.IDOBJECT_CLIFOR = 38750
	WHERE 
	   patindex(codlingua COLLATE Latin1_General_CI_AS + '%', bol.FileDescr) > 0


				
	UPDATE T 
	SET 
		T.IDDOC_BOL = ISNULL(bol.IDDOC, 0)
		, T.FILENAME_BOL = bol.FILENAME
		, T.IDOBJECT_BOL = bol.IDOBJECT_BOL
	FROM
		ITA_TABREGISTRONOTIFICHEBSC T JOIN Knos_ZSI.DBO.Metodo_View_LinkageBollettini bol 
		ON bol.IDOBJECT_ART = T.IDOBJECT_ART and bol.IDOBJECT_CLIFOR = T.IDOBJECT_CLI



		
	UPDATE 
		ITA_TABREGISTRONOTIFICHEBSC
	SET 
		EMAIL_CLIENTE = [dbo].[fn_GetEMAILCONTATTICLIENTE](CODCLIFOR)
		
	
	UPDATE  T 
	SET 
		T.EMAIL_AGENTE = V.EMAIL_AGENTI
	FROM
		ITA_TABREGISTRONOTIFICHEBSC T JOIN VISTA_EMAILAGENTICLIENTE V
		ON T.CODCLIFOR = V.CODCONTO
			
			
RETURN

END
GO

GRANT EXECUTE ON dbo.ITA_SP_UPDATE_REGISTRONOTIFICHEBSC TO Metodo98
GO






IF OBJECT_ID ('dbo.ZS_VISTA_NOTIFICHEBSC') IS NOT NULL
	DROP VIEW dbo.ZS_VISTA_NOTIFICHEBSC
GO

create view ZS_VISTA_NOTIFICHEBSC as 
SELECT 
	(CODCLIFOR + ' - ' + RAGIONESOCIALE) AS CLIENTE,
	CODART,
	DESCRIZIONEARTICOLO,
	DSCART_ALT AS DESCRIZIONE_ALTERNATIVA,
	EMAIL_CLIENTE,
	EMAIL_AGENTE,
	FILENAME_SCH,
	DATAULTIMOINVIO_SCH,
	CODICEDOCUMENTO_SCH,
	ARTICOLOBSC,
	CODLINGUA,
	CODCLIFOR,
	RAGIONESOCIALE,
	FILENAME_BOL,
	CODICEDOCUMENTO_BOL,
	DATAULTIMOINVIO_BOL,
	STATOINVIO_BOL,
	STATOINVIO_SCH,
	IDDOC_BOL,
	IDDOC_SCH,
	IDOBJECT_CLI,
	IDOBJECT_ART,
	IDOBJECT_BOL,
	IDOBJECT_SCH
FROM dbo.ITA_TABREGISTRONOTIFICHEBSC
GO

GRANT SELECT ON dbo.ZS_VISTA_NOTIFICHEBSC TO Metodo98
GO





TRUNCATE TABLE ITA_TABREGISTRONOTIFICHEBSC

EXECUTE dbo.ITA_SP_UPDATE_REGISTRONOTIFICHEBSC 


SELECT * FROM ITA_TABREGISTRONOTIFICHEBSC



IF OBJECT_ID ('dbo.VISTA_RELAZIONIARTICOLIBSC') IS NOT NULL
	DROP VIEW dbo.VISTA_RELAZIONIARTICOLIBSC
GO

CREATE VIEW [dbo].[VISTA_RELAZIONIARTICOLIBSC]
AS
SELECT * FROM (
SELECT 
	e.*
	, i.IdPubblicazioneKnos AS IDOBJECT
	, a.CODICE AS codartMetodo
	, a.DESCRIZIONE AS descrizioneMetodo
FROM EXCEL_RELAZIONIARTICOLIBSC e, anagraficaarticoli a 
	JOIN ITA_ARCHIVIO_ARTICOLI i ON i.CODICE = a.codice
WHERE e.CODICE <> '' AND charindex(e.CODICE, a.codice) > 0
UNION 
SELECT
	'' AS NOMEFILE
	, a.CODICE
	, (CASE WHEN charindex('#', a.CODICE) > 0 THEN LEFT(a.CODICE,charindex('#', a.CODICE)+3) ELSE a.CODICE END)
	, a.DESCRIZIONE AS FILEPREFIX
	, i.IdPubblicazioneKnos
	, a.CODICE
	, a.DESCRIZIONE
FROM anagraficaarticoli a JOIN extramag e ON a.CODICE = e.CODART
	JOIN ITA_ARCHIVIO_ARTICOLI i ON i.CODICE = a.codice
WHERE 
	e.BSCKNOS ='S'
	AND a.codice NOT IN (
		SELECT a.CODICE
		FROM EXCEL_RELAZIONIARTICOLIBSC e, anagraficaarticoli a 
		WHERE e.CODICE <> '' AND charindex(e.CODICE, a.codice) > 0
	)
) cte 
--WHERE cte.codice LIKE '20182%'
GO

GRANT DELETE ON dbo.VISTA_RELAZIONIARTICOLIBSC TO Metodo98
GO
GRANT INSERT ON dbo.VISTA_RELAZIONIARTICOLIBSC TO Metodo98
GO
GRANT REFERENCES ON dbo.VISTA_RELAZIONIARTICOLIBSC TO Metodo98
GO
GRANT SELECT ON dbo.VISTA_RELAZIONIARTICOLIBSC TO Metodo98
GO
GRANT UPDATE ON dbo.VISTA_RELAZIONIARTICOLIBSC TO Metodo98
GO
