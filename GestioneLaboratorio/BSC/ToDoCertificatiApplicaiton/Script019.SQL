
IF NOT EXISTS(SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'EXTRARIGHEDOC' AND COLUMN_NAME = 'RAGGRUPPAMENTO')
	ALTER TABLE EXTRARIGHEDOC ADD RAGGRUPPAMENTO VARCHAR(10)
GO



IF OBJECT_ID ('dbo.EXCEL_PORTAFOGLIOORDINI') IS NOT NULL
	DROP VIEW dbo.EXCEL_PORTAFOGLIOORDINI
GO

CREATE view EXCEL_PORTAFOGLIOORDINI as 

SELECT 
        R.DATACONSEGNA
        , (CASE WHEN ISNULL(ER.DATAPOSIZIONAMENTO, '') = '' THEN 'check-no.png' ELSE 'check-yes.png' END) AS ROWHEADERIMAGE
        --, ISNULL(u.GRUPPOM05, 0), ER.utentemodifica
        , (CASE         	
        	WHEN ISNULL(u.GRUPPOM05, 0) = 4 THEN 'check-yesM.png' 
        	WHEN ISNULL(u.GRUPPOM05, 0) = 3 THEN 'check-noM.png' 
        	ELSE 'check-reloadM.png' END
        	) AS ROWHEADERIMAGEM
        , (CASE WHEN datediff(d, getdate(), R.DATACONSEGNA) < -7 THEN -7 ELSE datediff(d, getdate(), R.DATACONSEGNA) END) AS gg_dataconsegna 
        , (CASE WHEN ACF.STATOBOLLE = 2 AND (CASE WHEN T.CODPAGAMENTO IN (SELECT CODICE FROM VISTA_PAGAMENTIANTICIPATI) THEN 1 ELSE 0 END) = 0 THEN '[BLOCCATO] ' 
	        WHEN ACF.STATOBOLLE = 2 AND (CASE WHEN T.CODPAGAMENTO IN (SELECT CODICE FROM VISTA_PAGAMENTIANTICIPATI) THEN 1 ELSE 0 END) = 1 THEN '[PAG. ANT.] ' 
        	ELSE '' END) + AC.DSCCONTO1 AS RAGIONESOCIALE
        , T.TIPODOC + '/' + CAST(T.ESERCIZIO AS VARCHAR) + '/' + RIGHT('000000' + CAST(T.NUMERODOC AS VARCHAR), 6) AS DOCUMENTO -- + '/' + CAST(R.POSIZIONE AS VARCHAR) AS DOCUMENTO 
        , T.NUMRIFDOC, ET.RIFCLI 
        , R.CODART AS ARTICOLO
        , (isnull((SELECT TOP 1 x.DSCART_ALT FROM VistaRelazioniCFVdaDocZSIM05 x WHERE x.PROGRESSIVO = t.progressivo AND x.IDRIGA = r.idriga), R.DESCRIZIONEART)  + '(' + ISNULL(AA.DESCRIZIONE, '')  + ')') AS DESCRIZIONE
        --, (R.DESCRIZIONEART + '(' + ISNULL(AA.DESCRIZIONE, '')  + ')') AS DESCRIZIONE
 		, I.DESCRIZIONE IMBALLO 
        , CAST(R.QTAGESTRES AS INT) AS QTAGESTRES
        , CAST(isnull(R.NRPEZZIIMBALLO, 0) AS INT) AS NRPEZZIIMBALLO
        , CAST(
        		(CASE WHEN ISNULL(R.NRPEZZIIMBALLO,0) = 0 THEN 0 
        				ELSE ceiling(R.QTAGESTRES/R.NRPEZZIIMBALLO) 
        				END)
         AS INT) FUSTI 
        , isnull(ER.NRLOTTO, '---') AS NRLOTTO
        , ISNULL(SD.RAGIONESOCIALE, '') AS SPEDIZIONIERE
        , (CASE WHEN ISNULL(ER.NOTECLI,'') <> '' THEN ER.NOTECLI ELSE NC.NOTE END) NOTECLI 
        , (CASE WHEN ISNULL(ER.NOTEART,'') <> '' THEN ER.NOTEART ELSE NA.NOTE END) NOTEART 
        , ER.NOTEMAG, '' MAGAZZINO 
        , ER.POSIZIONAMENTO
        , isnull(ER.CONFEZIONATO, 0) AS CONFEZIONATO
        --, isnull((SELECT TOP 1 x.disponibilita FROM ZSI_DISPONIBILITAM05 x WHERE x.CODCLIFOR = t.codclifor AND x.CODART = r.codart AND x.CODIMBALLO = R.CODIMBALLO), 0) AS DISPONIBILITA 
        , isnull((SELECT TOP 1 x.disponibilita FROM ZSI_DISPONIBILITAM05 x WHERE x.idtesta = r.idtesta AND x.IDRIGA = r.idriga), 0) AS DISPONIBILITA 
        , CAST(isnull(ER.QTASPEDIBILE, 0) AS INT) AS QTASPEDIBILE
        , CAST(isnull((CASE WHEN CAST(R.NRPEZZIIMBALLO AS INT) > 0 THEN R.QTAGESTRES/CAST(R.NRPEZZIIMBALLO AS INT) ELSE 0 END), 0) AS INT) AS COLLIDASPEDIRE
        , CAST(isnull((CASE WHEN CAST(R.NRPEZZIIMBALLO AS INT) > 0 THEN ER.QTASPEDIBILE/CAST(R.NRPEZZIIMBALLO AS INT) ELSE 0 END), 0) AS INT) AS COLLISPEDIBILI

        , '' AS TIPOPALLET
        , '' AS ETICHETTATURA
        , T.ESERCIZIO, T.TIPODOC, T.NUMERODOC, T.BIS, T.DATADOC 
        , '' AS EMAIL_CLIENTE --s.ferrigato@zschimmer-schwarz.com;m.michieletti@zschimmer-schwarz.com;
        , T.PROGRESSIVO AS IDTESTA, R.IDRIGA 
        , AA.GRUPPO, AA.CATEGORIA, AA.CODCATEGORIASTAT 
        , T.CODCLIFOR
        , T.DATARIFDOC
        , I.CODICE CODIMBALLO
        --, isnull(isnull(ET.CODSPEDMANDATO, ACF.CODSPED), 0) AS CODSPED
        , isnull(ET.CODSPEDMANDATO, 0) AS CODSPED
        , R.UMGEST
        , isnull(ER.DATACARICO, R.DATACONSEGNA) AS DATACARICO
        , ISNULL(ER.MAGSTATORIGA, 0) AS MAGSTATORIGA
        , ISNULL(ER.MAGSTATOM05, 0) AS MAGSTATOM05
        , (CASE WHEN ISNULL(ER.MAGSTATORIGA, 0) = 0 THEN '-'
	        WHEN ISNULL(ER.MAGSTATORIGA, 0) = 1 THEN 'INTERAMENTE'
	        WHEN ISNULL(ER.MAGSTATORIGA, 0) = 2 THEN 'PARZIALMENTE'
	        WHEN ISNULL(ER.MAGSTATORIGA, 0) = 3 THEN 'NON SPEDIBILE'
	        ELSE '-' END) AS DSCMAGSTATORIGA
        , (CASE WHEN ISNULL(ER.MAGSTATOM05, 0) = 0 THEN 'INSERITO'
	        WHEN ER.MAGSTATOM05 = 1 THEN 'PREVISIONE'
	        WHEN ER.MAGSTATOM05 = 2 THEN 'POSIZIONATO'
	        WHEN ER.MAGSTATOM05 = 3 THEN 'APPRONTATA SPED'
	        WHEN ER.MAGSTATOM05 = 4 THEN 'ASSEGNATI LOTTI'
	        ELSE '-' END) AS DSCMAGSTATOM05
        , (CASE WHEN isnull(EXTRACLIENTI.CLIENTESPECIALE, 'N') = 'S' THEN 1 ELSE 0 END) AS CLIENTESPECIALE
        , T.NUMDESTDIVERSAMERCI
        , R.ANNOTAZIONI
        , ET.NOTECONTAINER
        , (CASE WHEN T.RAGSOCDDM IS NULL THEN 
        		AC.DSCCONTO1 + ' ' + AC.INDIRIZZO + ' ' + AC.LOCALITA + ' ' + AC.PROVINCIA + ' ' + AC.CAP  
        	ELSE
        		t.RAGSOCDDM + ' ' + t.INDIRIZZODDM + ' ' + t.LOCALITADDM + ' ' + t.PROVINCIADDM  + ' ' + t.CAPDDM
        	END) AS DESTINAZIONE
        , (CASE WHEN isnull(ET.NOTECONTAINER ,'') <> '' THEN 'M14' 
        			WHEN r.CODIMBALLO IN (100, 101) THEN 'M13' 
        			ELSE 'M12' 
			END) AS MODULO
		, ARTADR.NUMONU
 		, ARTADR.CLASSEADR
 		-- XLS
 		, ISNULL(NC.M_MEZZO,'') AS M_MEZZO
 		, ISNULL(NC.M_COSTO,'') AS M_COSTO
        , '''' + CAST(DAY(ER.DATACARICO) AS VARCHAR) + '/' + CAST(MONTH(ER.DATACARICO) AS VARCHAR) + '/' + CAST(YEAR(ER.DATACARICO) AS VARCHAR) AS XLS_DATACARICO
        , '''' + CAST(DAY(R.DATACONSEGNA) AS VARCHAR) + '/' + CAST(MONTH(R.DATACONSEGNA) AS VARCHAR) + '/' + CAST(YEAR(R.DATACONSEGNA) AS VARCHAR) AS XLS_DATACONSEGNA
        , AC.DSCCONTO1 + ' [' + 'DOC. ' + T.TIPODOC + '/' + CAST(T.ESERCIZIO AS VARCHAR) + '/' + CAST(T.NUMERODOC AS VARCHAR) + ' - ' + T.NUMRIFDOC + ']' AS XLS_CLIENTE
        , (CASE WHEN ISNULL(T.RAGSOCDDM, '') = '' THEN 
        		AC.DSCCONTO1 + ' ' + AC.INDIRIZZO + ' ' + AC.LOCALITA + ' ' + AC.PROVINCIA + ' ' + AC.CAP   
        	ELSE
        		t.RAGSOCDDM + ' ' + t.INDIRIZZODDM + ' ' + t.LOCALITADDM + ' ' + t.PROVINCIADDM  + ' ' + t.CAPDDM 
        	END) AS XLS_DESTINAZIONE
        , (CAST( 
        	CAST(
        		(CASE WHEN ISNULL(R.NRPEZZIIMBALLO,0) = 0 THEN 0 
        				ELSE ceiling(R.QTAGESTRES/R.NRPEZZIIMBALLO) 
        				END)
         	AS INT) 
         AS VARCHAR) + ' ' + I.DESCRIZIONE) AS XLS_TIPOIMBALLO
        , isnull(ER.NRLOTTO, '---') AS XLS_NRLOTTO
        , ISNULL(ARTADR.NUMONU, '') AS XLS_NUMONU
        , ISNULL(ARTADR.CLASSEADR, 'NO') AS XLS_CLASSEADR
        --, ISNULL((SELECT TOP 1 TABSPEDIZ.RAGIONESOCIALE FROM  TABSPEDIZ WHERE TABSPEDIZ.CODICE = isnull(SD.CODSPED, 0)), '') AS XLS_SPEDIZIONIERE
        , ISNULL(SD.RAGIONESOCIALE, '') AS XLS_SPEDIZIONIERE
        , (CASE WHEN ISNULL(ER.NOTECLI,'') <> '' THEN ER.NOTECLI ELSE NC.NOTE END) + ' ' + R.ANNOTAZIONI AS XLS_NOTE
        , (CASE WHEN ISNULL(ER.NOTEART,'') <> '' THEN ER.NOTEART ELSE NA.NOTE END) XLS_NOTEART 
        , (CASE WHEN ISNULL(ER.NOTECLI,'') <> '' THEN ER.NOTECLI ELSE NC.NOTE END) + ' - ' + (CASE WHEN ISNULL(ER.NOTEART,'') <> '' THEN ER.NOTEART ELSE NA.NOTE END) 
         + ' ' + R.ANNOTAZIONI 
         + ' ' + ISNULL(NC.M_MEZZO, '') AS XLS_NOTECLIART
        , ER.NOTEMAG AS XLS_NOTEMAG
        , ISNULL(NC.M_COSTO,'') AS XLS_COSTO
        , ISNULL(NC.NOTECOSIGNEE, '') AS XLS_NOTECONSIGNEE
        , ISNULL(NC.NOTENOTIFY, '') AS XLS_NOTENOTIFY
        , CAST(CAST((CASE WHEN ISNULL(ER.QTASPEDIBILE, 0) = 0 THEN R.QTAGESTRES ELSE ER.QTASPEDIBILE END) AS INT) AS VARCHAR) AS XLS_QTA
        , ISNULL(ER.DATAPOSIZIONAMENTO, 
        (
        	CASE WHEN (SELECT COUNT(*) FROM TABPORTO WHERE TABPORTO.CODICE = T.PORTO AND LEFT(tabporto.DESCRIZIONE,3) = 'EXW') = 1 THEN ER.DATACARICO
        	WHEN T.TIPODOC = 'OCE' AND I.CODICE IN (100, 101) THEN ER.DATACARICO 
        	 
        	ELSE NULL  END)
        ) AS DATAPOSIZIONAMENTO
        , row_number() OVER(PARTITION BY ER.DATAPOSIZIONAMENTO ORDER BY ER.DATAPOSIZIONAMENTO) AS RN
        , K.IdPubblicazioneKnos AS IDOBJECT
        , ER.RAGGRUPPAMENTO
        , (isnull((SELECT TOP 1 x.DSCART_ALT FROM VistaRelazioniCFVdaDocZSIM05 x WHERE x.PROGRESSIVO = t.progressivo AND x.IDRIGA = r.idriga), R.DESCRIZIONEART)  + ' (' + ISNULL(AA.DESCRIZIONE, '')  + ')' ) AS XLS_DESCRIZIONE
        , (SELECT TOP 1 TABPORTO.DESCRIZIONE FROM TABPORTO WHERE TABPORTO.CODICE = T.PORTO) AS XLS_PORTO
        , (SELECT TOP 1 RAGSOCCOGNOME FROM TABDITTE) AS XLS_SHIPPER
        --, '' AS XLS_NOTE
        , '' AS XLS_DOCUMENTI
		, '' AS XLS_VUOTO
        --CLIENTE	N° ordine zsi	Codice ZSI	 PRODOTTO	Kg Tot.	Kg x fusto	N° fusti	Tipo pallet	Note	Etichettatura	Consegna	Posizionamento container	Disponibilità a magazzino
		
		, (CASE WHEN ACF.STATOBOLLE = 2 AND (CASE WHEN T.CODPAGAMENTO IN (SELECT CODICE FROM VISTA_PAGAMENTIANTICIPATI) THEN 1 ELSE 0 END) = 0 THEN '[BLOCCATO] ' 
	        WHEN ACF.STATOBOLLE = 2 AND (CASE WHEN T.CODPAGAMENTO IN (SELECT CODICE FROM VISTA_PAGAMENTIANTICIPATI) THEN 1 ELSE 0 END) = 1 THEN '[PAG. ANT.] ' 
        	ELSE '' END) + AC.DSCCONTO1 AS XLS_M05_ESTERO_CLIENTE        
		, T.TIPODOC + '/' + CAST(T.ESERCIZIO AS VARCHAR) + '/' + CAST(T.NUMERODOC AS VARCHAR) AS XLS_M05_ESTERO_DOCUMENTO        
		, R.CODART AS XLS_M05_ESTERO_ARTICOLO        
		, (isnull((SELECT TOP 1 x.DSCART_ALT FROM VistaRelazioniCFVdaDocZSIM05 x WHERE x.PROGRESSIVO = t.progressivo AND x.IDRIGA = r.idriga), R.DESCRIZIONEART)  + '(' + ISNULL(AA.DESCRIZIONE, '')  + ')') AS XLS_M05_ESTERO_DESCRIZIONE        
		, CAST(R.QTAGESTRES AS INT) AS XLS_M05_ESTERO_QTAGEST        
		, CAST(isnull((CASE WHEN CAST(R.NRPEZZIIMBALLO AS INT) > 0 THEN R.QTAGESTRES/CAST(R.NRPEZZIIMBALLO AS INT) ELSE 0 END), 0) AS INT) AS XLS_M05_ESTERO_NRCOLLI
		, CAST(isnull((CASE WHEN CAST(R.NRPEZZIIMBALLO AS INT) > 0 THEN CAST(R.NRPEZZIIMBALLO AS INT) ELSE 0 END), 0) AS INT) AS XLS_M05_ESTERO_NRPEZZIIMBALLO        
		, I.DESCRIZIONE AS XLS_M05_ESTERO_TIPOIMBALLO        
		, (CASE WHEN ISNULL(ER.NOTECLI,'') <> '' THEN ER.NOTECLI ELSE NC.NOTE END) AS XLS_M05_ESTERO_NOTE        
		, (CASE WHEN ISNULL(ER.NOTEART,'') <> '' THEN ER.NOTEART ELSE NA.NOTE END) AS XLS_M05_ESTERO_ETICHETTATURA       
		, '''' + CAST(DAY(R.DATACONSEGNA) AS VARCHAR) + '/' + CAST(MONTH(R.DATACONSEGNA) AS VARCHAR) + '/' + CAST(YEAR(R.DATACONSEGNA) AS VARCHAR) XLS_M05_ESTERO_CONSEGNA        
		, ER.POSIZIONAMENTO AS XLS_M05_ESTERO_POSIZIONAMENTO        
		--, isnull((SELECT TOP 1 x.disponibilita FROM ZSI_DISPONIBILITAM05 x WHERE x.CODCLIFOR = t.codclifor AND x.CODART = r.codart AND x.CODIMBALLO = R.CODIMBALLO), 0) AS XLS_M05_ESTERO_DISPONIBILITA        
		, isnull((SELECT TOP 1 x.disponibilita FROM ZSI_DISPONIBILITAM05 x WHERE x.idtesta = r.idtesta AND x.IDRIGA = r.idriga), 0) AS XLS_M05_ESTERO_DISPONIBILITA 
		--, (CASE WHEN T.CODPAGAMENTO IN (SELECT CODICE FROM VISTA_PAGAMENTIANTICIPATI) THEN 1 ELSE 0 END)
		, ISNULL(T.RAGSOCDDM, '') AS XLS_DESTINAZIONERAGSOC        
        , '''' + convert(VARCHAR, ISNULL(ER.DATAPOSIZIONAMENTO, 
        (
        	CASE WHEN (SELECT COUNT(*) FROM TABPORTO WHERE TABPORTO.CODICE = T.PORTO AND LEFT(tabporto.DESCRIZIONE,3) = 'EXW') = 1 THEN ER.DATACARICO
        	WHEN T.TIPODOC = 'OCE' AND I.CODICE IN (100, 101) THEN ER.DATACARICO
        	ELSE ER.DATACARICO END)
        ), 103) AS XLS_DATAPOSIZIONAMENTO
        , ISNULL(NC.M_MEZZO, '') AS XLS_MEZZO
        , ISNULL(NC.NOTESHIPPER, 'ZSI') AS XLS_NOTESHIPPER
        , ISNULL(NC.NOTEDOCUMENTI, '') AS XLS_NOTEDOCUMENTI
        , ISNULL(ND.NOTE, '') +  ' ' + ISNULL(ND.NOTE2, '') AS XLS_NOTECFINDOC
		, isnull(ET.NOTECONTAINER, '')  + ' ' + ISNULL(NC.M_MEZZO, '') AS XLS_M14NOTECONTAINER
		, ISNULL(DD.NOTE, '') AS XLS_NOTEDESTINAZIONEDIVERSA
		
		, (SELECT TOP 1  XX.UTENTE + ' ' + CONVERT(VARCHAR, XX.DATAMODIFICA, 113) FROM LOG_EXTRARIGHEDOCM05 XX WHERE XX.IDTESTA = R.IDTESTA AND XX.IDRIGA = R.IDRIGA ORDER BY XX.DATAMODIFICA DESC) AS INFOMODIFICA
		, (CASE WHEN T.RAGSOCDDM IS NULL THEN 
        		AC.DSCCONTO1 + ' '  + AC.LOCALITA + ' ' + AC.PROVINCIA   
        	ELSE
        		t.RAGSOCDDM + ' ' + t.LOCALITADDM + ' ' + t.PROVINCIADDM 
        	END) AS DESTINAZIONEMAILCOMM
        , CAST( isnull(ER.QTASPEDIBILE, 0) AS INT) AS QTASPEDIBILECOMM
        , (SELECT count(z.progressivo) FROM ZSI_CONFEZSPEDIBILE z WHERE z.IDTESTADDT = 0 AND z.LOTTO <> '---' AND z.PROGRESSIVO = R.IDTESTA AND z.IDRIGA = R.IDRIGA AND ISNULL(z.IDTESTADDT, 0) = 0) AS ZCOUNT
        , CONVERT(DATE, ER.DATAMODIFICAPOSIZIONAMENTO) AS DATAMODIFICA
        , ER.UTENTEPOSIZIONAMENTO AS UTENTEMODIFICA--, ER.UTENTEMODIFICA
        
        -- M15
        , '''' + convert(VARCHAR, ISNULL(ER.DATAPOSIZIONAMENTO, 
        (
        	CASE WHEN (SELECT COUNT(*) FROM TABPORTO WHERE TABPORTO.CODICE = T.PORTO AND LEFT(tabporto.DESCRIZIONE,3) = 'EXW') = 1 THEN ER.DATACARICO
        	WHEN T.TIPODOC = 'OCE' AND I.CODICE IN (100, 101) THEN ER.DATACARICO
        	ELSE ER.DATACARICO END)
        ), 103) AS XLS_M15_DATACONSEGNA 
        , CAST(ER.QTASPEDIBILE AS INT) AS XLS_M15_QTASPEDIBILE 
        , CAST(CAST(isnull((CASE WHEN CAST(R.NRPEZZIIMBALLO AS INT) > 0 THEN ER.QTASPEDIBILE/CAST(R.NRPEZZIIMBALLO AS INT) ELSE 0 END), 0) AS INT) AS VARCHAR) + ' ' +  I.DESCRIZIONE AS XLS_M15_ESTERO_TIPOIMBALLO 
        , '' AS XLS_M15_RESA
        , 'ZSI' AS XLS_M15_SHIPPER
        , ISNULL(ARTADR.NUMONU, '') AS XLS_M15_NUMONU
        , ISNULL(ARTADR.CLASSEADR, 'NO') AS XLS_M15_CLASSEADR
        , (CASE WHEN ISNULL(T.RAGSOCDDM, '') = '' THEN 
        		AC.DSCCONTO1 + ' ' + AC.INDIRIZZO + ' ' + AC.LOCALITA + ' ' + AC.PROVINCIA + ' ' + AC.CAP   
        	ELSE
        		t.RAGSOCDDM + ' ' + t.INDIRIZZODDM + ' ' + t.LOCALITADDM + ' ' + t.PROVINCIADDM  + ' ' + t.CAPDDM 
        	END)  AS XLS_M15_DESTINAZIONE
	FROM TESTEDOCUMENTI T WITH (NOLOCK) JOIN EXTRATESTEDOC ET WITH (NOLOCK) ON T.PROGRESSIVO = ET.IDTESTA 
	JOIN RIGHEDOCUMENTI R WITH (NOLOCK) ON T.PROGRESSIVO = R.IDTESTA 
	JOIN ANAGRAFICACF AC WITH (NOLOCK) ON AC.CODCONTO = T.CODCLIFOR 
	JOIN EXTRACLIENTI WITH (NOLOCK) ON EXTRACLIENTI.CODCONTO = AC.CODCONTO
	JOIN ANAGRAFICAARTICOLI AA WITH (NOLOCK) ON AA.CODICE = R.CODART 
	JOIN EXTRARIGHEDOC ER WITH (NOLOCK) ON ER.IDTESTA = R.IDTESTA AND ER.IDRIGA = R.IDRIGA 
	JOIN ANAGRAFICARISERVATICF ACF WITH (NOLOCK) ON ACF.ESERCIZIO = YEAR(GETDATE()) AND ACF.CODCONTO = T.CODCLIFOR 
	--LEFT OUTER JOIN ZSI_CONFEZSPEDIBILE z WITH (NOLOCK) ON Z.PROGRESSIVO = r.IDTESTA AND z.idriga = r.IDRIGA
	LEFT OUTER JOIN TAB_ARTICOLIADR ARTADR WITH (NOLOCK) ON ARTADR.CODART = R.CODART
	LEFT OUTER JOIN TABIMBALLI I WITH (NOLOCK) ON R.CODIMBALLO = I.CODICE 
	LEFT OUTER JOIN ZSI_NOTECLI NC WITH (NOLOCK) ON T.CODCLIFOR = NC.CODCLI AND (T.NUMDESTDIVERSAMERCI = NC.CODDEST OR (T.NUMDESTDIVERSAMERCI = 0 AND NC.CODDEST = -1) OR (T.NUMDESTDIVERSAMERCI <> 0 AND NOT EXISTS(SELECT 1 FROM ZSI_NOTECLI Z WHERE Z.CODCLI = T.CODCLIFOR AND Z.CODDEST = T.NUMDESTDIVERSAMERCI) AND NC.CODDEST = -1) ) 
	LEFT OUTER JOIN ZSI_NOTEART NA WITH (NOLOCK) ON T.CODCLIFOR = NA.CODCLI AND R.CODART = NA.CODART 
		 AND (T.NUMDESTDIVERSAMERCI = NA.CODDEST 
		 OR (T.NUMDESTDIVERSAMERCI = 0 AND NA.CODDEST = -1) 
		 OR (T.NUMDESTDIVERSAMERCI <> 0 AND NOT EXISTS(SELECT 1 FROM ZSI_NOTEART Z WHERE Z.CODCLI = T.CODCLIFOR AND Z.CODDEST = T.NUMDESTDIVERSAMERCI) AND NA.CODDEST = -1) 
		 )
	--LEFT OUTER JOIN SPEDIZDOCUMENTI SD WITH (NOLOCK) ON SD.IDTESTA = t.PROGRESSIVO
	LEFT OUTER JOIN TABSPEDIZ SD WITH (NOLOCK) ON ET.CODSPEDMANDATO = SD.CODICE
	LEFT OUTER JOIN ITA_ARCHIVIO_DOCUMENTI K WITH (NOLOCK) ON K.Progressivo = T.PROGRESSIVO
	LEFT OUTER JOIN DESTINAZIONIDIVERSE DD WITH (NOLOCK) ON DD.CODCONTO = T.CODCLIFOR AND DD.CODICE = T.NUMDESTDIVERSAMERCI
	LEFT OUTER JOIN NOTECFINDOC ND WITH (NOLOCK) ON ND.CODCONTO = T.CODCLIFOR AND ND.TIPODOC = T.TIPODOC AND ND.ESERCIZIO = T.ESERCIZIO
	LEFT OUTER JOIN TABUTENTI U ON U.USERID = ER.UTENTEPOSIZIONAMENTO
	
WHERE 
	t.tipodoc IN ('OCC', 'OCE')  
	AND t.esercizio >= year(getdate())-2
	AND R.CODART <> '' 
	--AND (R.QTAGESTRES > 0) 
	AND ((R.QTAGESTRES > 0) OR (R.QTAGESTRES = 0 AND er.DATAPOSIZIONAMENTO >= convert(DATE, getdate())))
	--AND t.numerodoc = 1449
GO

GRANT DELETE ON dbo.EXCEL_PORTAFOGLIOORDINI TO Metodo98
GO

GRANT INSERT ON dbo.EXCEL_PORTAFOGLIOORDINI TO Metodo98
GO

GRANT REFERENCES ON dbo.EXCEL_PORTAFOGLIOORDINI TO Metodo98
GO

GRANT SELECT ON dbo.EXCEL_PORTAFOGLIOORDINI TO Metodo98
GO

GRANT UPDATE ON dbo.EXCEL_PORTAFOGLIOORDINI TO Metodo98
GO



IF OBJECT_ID ('dbo.ITA_SP_UPDATE_DATEPOSIZIONAMENTO') IS NOT NULL
	DROP PROCEDURE dbo.ITA_SP_UPDATE_DATEPOSIZIONAMENTO
GO

CREATE PROCEDURE [dbo].[ITA_SP_UPDATE_DATEPOSIZIONAMENTO]
(

@idtesta DECIMAL(10)
, @idriga DECIMAL(5)
, @dataposizionamento DATETIME
, @codsped AS DECIMAL(5)
, @chiudi SMALLINT = 0
, @giorno SMALLINT = 0
, @datacarico DATETIME = null
, @dataconsegna DATETIME = NULL
, @user VARCHAR(255) = ''
, @magstatom05 SMALLINT = 1
)
AS

BEGIN

	SET NOCOUNT ON
	
	IF @idtesta > 0
	BEGIN
	
		-- gestione del log di aggiornamento di date posizionamento
		DECLARE @u SMALLINT
		
		SELECT @u = count(*) 
		FROM EXTRARIGHEDOC 
		WHERE IDTESTA = @idtesta AND idriga = @idriga 
		AND  (DATAPOSIZIONAMENTO <> convert(DATE, @dataposizionamento) OR DATAPOSIZIONAMENTO IS NULL)
		
		IF (@u > 0)
		BEGIN
			DELETE FROM ZSI_LOGAGGIORNAMENTOPOSIZIONAMENTO WHERE PROGRESSIVO = @idtesta AND IDRIGA = @idriga
		
			INSERT INTO ZSI_LOGAGGIORNAMENTOPOSIZIONAMENTO
			(
				PROGRESSIVO,
				IDRIGA,
				UTENTEMODIFICA,
				DATAMODIFICA
			)
			VALUES
			(
				@idtesta, @idriga, @user, getdate()
			)
		END
	
	
		-- aggiornamento dati extra
		UPDATE EXTRARIGHEDOC
		SET DATAPOSIZIONAMENTO = convert(DATE, @dataposizionamento), MAGSTATOM05 = @magstatom05, DATAMODIFICA = GETDATE(), UTENTEPOSIZIONAMENTO = @user, DATAMODIFICAPOSIZIONAMENTO = convert(DATE, getdate())
		WHERE IDTESTA = @idtesta AND idriga = @idriga
		
		IF NOT (@datacarico IS NULL)
		BEGIN
		UPDATE EXTRARIGHEDOC
			SET datacarico = convert(DATE, @datacarico)
			WHERE IDTESTA = @idtesta AND idriga = @idriga
		END 

		IF NOT (@dataconsegna IS NULL)
		BEGIN
		UPDATE RIGHEDOCUMENTI
			SET DATACONSEGNA = convert(DATE, @dataconsegna)
			WHERE IDTESTA = @idtesta AND idriga = @idriga
		END 

		IF (@chiudi = 1)
		BEGIN
			UPDATE EXTRARIGHEDOC
			SET QTASPEDIBILE =  (SELECT x.qtagestres FROM RIGHEDOCUMENTI x WHERE x.IDTESTA = @idtesta AND x.IDRIGA = @idriga)
				, MAGSTATOM05 = @magstatom05
				, MAGSTATORIGA = 1
			WHERE IDTESTA = @idtesta AND idriga = @idriga
		END
		
		-- aggiornamento spedizioniere
		IF @codsped > 0
		BEGIN
		
			UPDATE EXTRATESTEDOC SET CODSPEDMANDATO = @CODSPED WHERE IDTESTA = @IDTESTA
				
		END
		
		DELETE FROM Appointments 
		WHERE 
			mkey = CAST(@idtesta AS VARCHAR) + '|' + CAST(@idriga AS VARCHAR)
	END 	
	
	IF @giorno = 1
	BEGIN
		-- appuntamenti
		DELETE FROM Appointments 
		WHERE 
			mkey = CAST(@idtesta AS VARCHAR) + '|' + CAST(@idriga AS VARCHAR)
			OR convert(DATE, start) = convert(DATE, @dataposizionamento)
			
		
		INSERT INTO dbo.Appointments (Summary, Start, [End], RecurrenceRule, MasterEventId, Location, Description, BackgroundId, mkey, TIPOIMBALLO, TIPOORDINE)
		SELECT 
		Summary, Start, [End], RecurrenceRule, MasterEventId, Location, Description, BackgroundId, mkey, TIPOIMBALLO, TIPOORDINE 
		FROM GET_PORTAFOGLIOORDINI_APPOINTMENTS(convert(DATE, @dataposizionamento)) -- idtesta = @idtesta AND idriga = @idriga	
	END	
	

	RETURN

END
GO

GRANT EXECUTE ON dbo.ITA_SP_UPDATE_DATEPOSIZIONAMENTO TO Metodo98
GO



IF OBJECT_ID ('dbo.GET_EXCEL_PORTAFOGLIOORDINI_COA') IS NOT NULL
	DROP FUNCTION dbo.GET_EXCEL_PORTAFOGLIOORDINI_COA
GO

CREATE FUNCTION [dbo].[GET_EXCEL_PORTAFOGLIOORDINI_COA]
    (
       @DATAPOSIZIONAMENTO VARCHAR(10)
    )
RETURNS TABLE
AS RETURN
    ( 
		
	SELECT ARTICOLO, DESCRIZIONE, RAGIONESOCIALE AS CLIENTE
	, COLLI
	, IMBALLO
	, ADR
	, LOTTO
	, DOCUMENTO
	, DESTINAZIONE
	, DATAPOSIZIONAMENTO
	, IDTESTA
	, IDRIGA
	, QTASPEDIBILE
	FROM (
		SELECT 
			ARTICOLO,
			DESCRIZIONE, 
			EXCEL_PORTAFOGLIOORDINI.COLLISPEDIBILI AS COLLI,
			IMBALLO,
			EXCEL_PORTAFOGLIOORDINI.XLS_CLASSEADR AS ADR,
			EXCEL_PORTAFOGLIOORDINI.NRLOTTO AS LOTTO,
			DESTINAZIONE,
 			DATAPOSIZIONAMENTO,
			DOCUMENTO,
			idtesta,
			idriga,
			QTASPEDIBILE,
			RAGIONESOCIALE
		FROM EXCEL_PORTAFOGLIOORDINI
		WHERE DATAPOSIZIONAMENTO = @DATAPOSIZIONAMENTO
		AND TIPODOC = 'OCE' AND CODIMBALLO NOT IN (100, 101)
		
		UNION
		
		SELECT 
			'ZZZZZZZZZZZZZZ' AS ARTICOLO,
			' ' AS DESCRIZIONE,
			0 AS COLLI,
			'' AS IMBALLO,
			'' AS ADR,
			'' AS LOTTO,
			'' AS DESTINAZIONE,
			DATAPOSIZIONAMENTO,
			'' AS DOCUMENTO,
			0 AS idtesta,
			0 AS idriga,
			0 AS QTASPEDIBILE,
			RAGIONESOCIALE
		FROM dbo.EXCEL_PORTAFOGLIOORDINI
		WHERE DATAPOSIZIONAMENTO = @DATAPOSIZIONAMENTO
		AND TIPODOC = 'OCE' AND CODIMBALLO NOT IN (100, 101)
		GROUP BY DATAPOSIZIONAMENTO, RAGIONESOCIALE
	
		UNION
		
		SELECT 
			'TOTALE ' AS ARTICOLO,
			'SPEDIBILE ' AS DESCRIZIONE,
			SUM(EXCEL_PORTAFOGLIOORDINI.COLLISPEDIBILI) AS COLLI,
			CAST(CAST(SUM(QTASPEDIBILE) AS INT) AS VARCHAR) + ' KG' AS IMBALLO,
			'' AS ADR,
			'' AS LOTTO,
			'ZZZZZZZZZZ' AS DESTINAZIONE,
			DATAPOSIZIONAMENTO,
			'' AS DOCUMENTO,
			0 AS idtesta,
			0 AS idriga,
			0 AS QTASPEDIBILE,
			RAGIONESOCIALE
		FROM dbo.EXCEL_PORTAFOGLIOORDINI
		WHERE DATAPOSIZIONAMENTO = @DATAPOSIZIONAMENTO 
		AND TIPODOC = 'OCE' AND CODIMBALLO NOT IN (100, 101)
		GROUP BY DATAPOSIZIONAMENTO, RAGIONESOCIALE
	) 
	CTE


)
GO

GRANT DELETE ON dbo.GET_EXCEL_PORTAFOGLIOORDINI_COA TO Metodo98
GO
GRANT INSERT ON dbo.GET_EXCEL_PORTAFOGLIOORDINI_COA TO Metodo98
GO
GRANT REFERENCES ON dbo.GET_EXCEL_PORTAFOGLIOORDINI_COA TO Metodo98
GO
GRANT SELECT ON dbo.GET_EXCEL_PORTAFOGLIOORDINI_COA TO Metodo98
GO
GRANT UPDATE ON dbo.GET_EXCEL_PORTAFOGLIOORDINI_COA TO Metodo98
GO


IF OBJECT_ID ('dbo.EXCEL_PORTAFOGLIOORDINI_APPOINTMENTS') IS NOT NULL
	DROP VIEW dbo.EXCEL_PORTAFOGLIOORDINI_APPOINTMENTS
GO

create view EXCEL_PORTAFOGLIOORDINI_APPOINTMENTS as 


SELECT 
e.DESCRIZIONE as Summary

--, rn
--, dateadd(N, (8 * 60) + (rn * 30), DATAPOSIZIONAMENTO) AS Start
--, dateadd(N, (8 * 60) + ((rn + 1) * 30), DATAPOSIZIONAMENTO) AS [End]
, '' AS RecurrenceRule
, 0 as MasterEventId
, LEFT(' Cliente: ' + e.RAGIONESOCIALE  + ' Ordine: ' + CAST(e.NUMERODOC AS VARCHAR) + e.DESTINAZIONE, 255) AS Location
, e.DESCRIZIONE 
	+ ' Cliente: ' + e.RAGIONESOCIALE 
	+ ' Q.tà: ' + CAST(CAST(XLS_QTA AS INT) AS VARCHAR) 
	+ ' [' + IMBALLO + '] Lotto: ' + NRLOTTO 
	+ ' Ordine: ' + CAST(e.NUMERODOC AS VARCHAR)
	+ ' Fusti/Cubi: ' + CAST(e.NRPEZZIIMBALLO AS VARCHAR)
	
	AS Description
--, (CASE WHEN e.MAGSTATORIGA = 1 THEN 4 
--WHEN e.MAGSTATORIGA = 2 THEN 11
--WHEN e.MAGSTATORIGA = 3 THEN 2
--ELSE 1 END) AS BackgroundId
, (CASE WHEN E.TIPODOC = 'OCE' THEN 7 ELSE 1 END) AS BackgroundId
, CAST(e.idtesta AS VARCHAR) + '|' + CAST(e.idriga AS VARCHAR) AS MKEY
, e.IDTESTA, e.idriga
, e.DATACARICO
, e.DATAPOSIZIONAMENTO
, (CASE WHEN IMBALLO = 'CISTERNA' THEN 'C' ELSE 'I' END) AS TIPOIMBALLO
, (CASE WHEN E.TIPODOC = 'OCE' THEN 'E' ELSE 'I' END) AS TIPOORDINE
, E.RAGIONESOCIALE
FROM EXCEL_PORTAFOGLIOORDINI e
GO

GRANT DELETE ON dbo.EXCEL_PORTAFOGLIOORDINI_APPOINTMENTS TO Metodo98
GO
GRANT INSERT ON dbo.EXCEL_PORTAFOGLIOORDINI_APPOINTMENTS TO Metodo98
GO
GRANT REFERENCES ON dbo.EXCEL_PORTAFOGLIOORDINI_APPOINTMENTS TO Metodo98
GO
GRANT SELECT ON dbo.EXCEL_PORTAFOGLIOORDINI_APPOINTMENTS TO Metodo98
GO
GRANT UPDATE ON dbo.EXCEL_PORTAFOGLIOORDINI_APPOINTMENTS TO Metodo98
GO



IF OBJECT_ID ('dbo.fn_GetLOTTIM05') IS NOT NULL
	DROP FUNCTION dbo.fn_GetLOTTIM05
GO

create function [dbo].[fn_GetLOTTIM05](@IdTesta decimal(10, 0), @IdRiga decimal(5, 0)) returns varchar(8000) as begin
	declare @Str varchar(1000)
	
	set @Str = ''
	
	select @Str = @Str + (case @Str when '' then '' else '-' end) + cast(r.LOTTO as varchar) + ' (' + CAST(CAST(max(r.QTACONFEZIONE) AS INT) AS VARCHAR) + ')'
	from ZSI_CONFEZSPEDIBILE R 
	WHERE R.PROGRESSIVO = @IdTesta AND R.IDRIGA = @IdRiga
	AND patindex('%---%', r.lotto) = 0 and r.idtestaddt = 0
	group by r.LOTTO

	IF @str = ''
	BEGIN
		-- imposto a 0 altrimenti la pubblicazione va in errore 
		SET @str = ''
	END

	return @Str
end
GO

GRANT EXECUTE ON dbo.fn_GetLOTTIM05 TO Metodo98
GO
GRANT REFERENCES ON dbo.fn_GetLOTTIM05 TO Metodo98
GO






IF OBJECT_ID ('dbo.VistaRelazioniCFVdaDocZSI_BSC') IS NOT NULL
	DROP VIEW dbo.VistaRelazioniCFVdaDocZSI_BSC
GO

CREATE VIEW [dbo].[VistaRelazioniCFVdaDocZSI_BSC] AS 
SELECT w.CODCLIFOR
	, W.CODART
	, (CASE WHEN V1.ARTICOLOBSC <> '' THEN X.ARTICOLOBSC ELSE w.codart END) AS ARTICOLOBSC
	, (CASE WHEN V1.ARTICOLOBSC <> '' THEN X.DSCART_ALT ELSE v1.DSCART_ALT END) AS DSCART_ALT
--	, isnull(isnull(V1.ARTICOLOBSC,X.ARTICOLOBSC),w.codart) AS ARTICOLOBSC
FROM 
	(	select codclifor,codart
		from  TESTEDOCUMENTI t JOIN RIGHEDOCUMENTI r ON t.PROGRESSIVO = r.IDTESTA
		WHERE t.CODCLIFOR LIKE 'C%'
			 AND t.datadoc >= CAST(CAST(YEAR(GETDATE())-2 AS VARCHAR) + '0101' AS DATETIME)
			 AND t.TIPODOC IN (SELECT codice FROM PARAMETRIDOC WHERE CLIFOR = 'C' AND TIPO = 'B' --AND CODICE <> 'DCG' --  RIMOSSO IL 04/10/2017
			 AND LEFT(CODICE, 1 ) = 'D')
			AND codart <> ''
		GROUP BY codclifor,codart
		 ) AS w 
	LEFT OUTER JOIN  VISTARELAZIONICFV V1 ON v1.codclifor = W.codclifor AND v1.CodArticolo = w.codart 
	LEFT OUTER JOIN VISTARELAZIONICFV X ON X.CODCLIFOR = 'C' AND X.CodArticolo = w.codart
GO

GRANT DELETE ON dbo.VistaRelazioniCFVdaDocZSI_BSC TO Metodo98
GO

GRANT INSERT ON dbo.VistaRelazioniCFVdaDocZSI_BSC TO Metodo98
GO

GRANT REFERENCES ON dbo.VistaRelazioniCFVdaDocZSI_BSC TO Metodo98
GO

GRANT SELECT ON dbo.VistaRelazioniCFVdaDocZSI_BSC TO Metodo98
GO

GRANT UPDATE ON dbo.VistaRelazioniCFVdaDocZSI_BSC TO Metodo98
GO




IF OBJECT_ID ('dbo.ITA_SP_UPDATE_DATISPEDIZIONE') IS NOT NULL
	DROP PROCEDURE dbo.ITA_SP_UPDATE_DATISPEDIZIONE
GO

CREATE PROCEDURE [dbo].[ITA_SP_UPDATE_DATISPEDIZIONE]
(

@idtesta DECIMAL(10)
, @idriga DECIMAL(5)
, @codsped AS DECIMAL(5)
, @qtaspedibile AS DECIMAL(16,6)
, @disponibilita AS DECIMAL(16,6)
, @posizionamento AS VARCHAR(50)
, @nrlotto AS VARCHAR(50)
, @magstatoriga AS SMALLINT 
, @magstatom05 SMALLINT
, @notecli VARCHAR(3000)
, @noteart VARCHAR(3000)
, @notemag VARCHAR(3000)
, @annotazioni VARCHAR(100)
, @coddestdiv DECIMAL(5)
, @noteconsignee VARCHAR(1000)
, @notenotify VARCHAR(1000)
, @notecontainer VARCHAR(1000)
, @datacarico DATETIME
, @dataconsegna DATETIME
, @dataposizionamento DATETIME
, @user VARCHAR(255) = ''
, @machine VARCHAR(255) = ''
, @m_mezzo VARCHAR(255) = ''
, @m_costo VARCHAR(255) = ''
, @noteshipper VARCHAR(1000) = ''
, @notedocumenti VARCHAR(1000) = ''
, @noteddc VARCHAR(1000) = ''
, @raggruppamento VARCHAR(10) = ''
)
AS

BEGIN

	DECLARE @codconto VARCHAR(7)
	DECLARE @numdestdiversamerci DECIMAL(5)
	


	-- gestione del log di aggiornamento di date posizionamento
	DECLARE @u SMALLINT
	
	SELECT @u = count(*) 
	FROM EXTRARIGHEDOC 
	WHERE IDTESTA = @idtesta AND idriga = @idriga 
	AND  (DATAPOSIZIONAMENTO <> convert(DATE, @dataposizionamento) OR DATAPOSIZIONAMENTO IS NULL)
	
	IF (@u > 0)
	BEGIN
		DELETE FROM ZSI_LOGAGGIORNAMENTOPOSIZIONAMENTO WHERE PROGRESSIVO = @idtesta AND IDRIGA = @idriga
	
		INSERT INTO ZSI_LOGAGGIORNAMENTOPOSIZIONAMENTO
		(
			PROGRESSIVO,
			IDRIGA,
			UTENTEMODIFICA,
			DATAMODIFICA
		)
		VALUES
		(
				@idtesta, @idriga, @user, getdate()
		)
	END


	
	SELECT TOP 1 @codconto = CODCLIFOR
		, @numdestdiversamerci = NUMDESTDIVERSAMERCI 
	FROM TESTEDOCUMENTI WHERE PROGRESSIVO = @idtesta 

	SET NOCOUNT ON
	
	UPDATE  ITA_ARCHIVIO_DOCUMENTI 
	SET TestPubblicazione = 1 
	WHERE Progressivo = @idtesta
	

	DECLARE @codart VARCHAR(50)
	SELECT @codart = CODART FROM RIGHEDOCUMENTI WHERE IDTESTA = @idtesta AND IDRIGA = @idriga

	DECLARE @codcli VARCHAR(7)
	SELECT @codcli = CODCLIFOR, @coddestdiv = (CASE WHEN ISNULL(NUMDESTDIVERSAMERCI, 0) = 0 THEN -1 ELSE NUMDESTDIVERSAMERCI END) 
	FROM TESTEDOCUMENTI WHERE PROGRESSIVO = @idtesta 

	DECLARE @esistenota SMALLINT
	
	UPDATE EXTRATESTEDOC 
	SET notecontainer = @notecontainer
	WHERE IDTESTA = @idtesta
	
	-- aggiornamento dati riga
	UPDATE RIGHEDOCUMENTI
	SET ANNOTAZIONI = @annotazioni
	, DATACONSEGNA = @dataconsegna
	WHERE IDTESTA = @idtesta AND idriga = @idriga
	
	
	
	DECLARE @nrlotti VARCHAR(1000)
	SELECT @nrlotti = dbo.fn_GetLOTTIM05(@idtesta, @idriga)

	IF @nrlotti <> ''
	BEGIN
		SET @nrlotto = @nrlotti
	END
	
	DECLARE @qtalotti AS DECIMAL(16,6)
	SELECT @qtalotti = sum(QTACONFEZIONE) 
	FROM ZSI_CONFEZSPEDIBILE
	WHERE PROGRESSIVO = @idtesta AND idriga = @idriga AND LEFT(lotto, 3) <> '---' and idtestaddt = 0
	GROUP BY PROGRESSIVO, idriga
	
	IF isnumeric(@qtalotti) = 1
	BEGIN
		SET @qtaspedibile  = @qtalotti	
	END
			
	
	-- aggiornamento dati extra
	UPDATE EXTRARIGHEDOC
	SET --DISPONIBILITA = @disponibilita	, 
	NRLOTTO = @nrlotto
	, POSIZIONAMENTO = @posizionamento
	--, CONFEZIONATO = @confezionato
	, QTASPEDIBILE = @qtaspedibile
	, MAGSTATOM05 = @magstatom05
	, MAGSTATORIGA = @magstatoriga
	, NOTEMAG = @notemag
	, DATACARICO = @datacarico
	, DATAPOSIZIONAMENTO = convert(DATE, @dataposizionamento)
	, RAGGRUPPAMENTO = @raggruppamento 
	WHERE IDTESTA = @idtesta AND idriga = @idriga



	
	EXEC ITA_SP_UPDATE_DISPONIBILITA @idtesta, @idriga, @disponibilita, @posizionamento

	
	SELECT @esistenota = count(*) FROM ZSI_NOTEART
	WHERE CODART = @codart AND CODCLI = @codcli AND CODDEST = @coddestdiv
	
	IF (@esistenota = 0)
	BEGIN
		INSERT INTO dbo.ZSI_NOTEART (CODCLI, CODDEST, CODART, NOTE, UTENTEMODIFICA, DATAMODIFICA)
		VALUES (@codcli, @coddestdiv, @codart, @noteart, 'trm', getdate())
	END
	

	UPDATE ZSI_NOTEART
	SET NOTE = @noteart
	WHERE CODART = @codart AND CODCLI = @codcli AND CODDEST = @coddestdiv




	SELECT @esistenota = count(*) FROM ZSI_NOTECLI
	WHERE CODCLI = @codcli AND CODDEST = @coddestdiv
	
	IF (@esistenota = 0)
	BEGIN
		INSERT INTO dbo.ZSI_NOTECLI (CODCLI, NOTE, UTENTEMODIFICA, DATAMODIFICA, CODDEST, NOTECOSIGNEE, NOTENOTIFY, M_MEZZO, M_COSTO, NOTESHIPPER, NOTEDOCUMENTI)
		VALUES (@codcli, @notecli, 'trm', getdate(), @coddestdiv, @noteconsignee, @notenotify, @m_mezzo, @m_costo, @noteshipper, @notedocumenti)
	END
		

	UPDATE ZSI_NOTECLI
	SET NOTE = @notecli
	, NOTECOSIGNEE =  @noteconsignee
	, NOTENOTIFY = @notenotify
	, M_MEZZO = @m_mezzo
	, M_COSTO = @m_costo
	, NOTESHIPPER =  @noteshipper
	, NOTEDOCUMENTI = @notedocumenti
	WHERE CODCLI = @codcli AND CODDEST = @coddestdiv

	

	-- aggiornamento spedizioniere
	IF @codsped > 0
	BEGIN
		UPDATE EXTRATESTEDOC SET CODSPEDMANDATO = @codsped WHERE IDTESTA = @idtesta
		
--		DELETE FROM SPEDIZDOCUMENTI WHERE IDTESTA = @idtesta
		
--		INSERT INTO dbo.SPEDIZDOCUMENTI (IDTESTA, POSSPED, POSIZIONE, CODSPED, RAGSOCSPED, INDIRIZZOSPED, CAPSPED, LOCALITASPED, PROVSPED, UTENTEMODIFICA, DATAMODIFICA, PARTITAIVA, CODNAZIONE, NUMALBOTR)
--		SELECT @idtesta, 1, 1, @codsped, RAGIONESOCIALE, indirizzo, CAP, LOCALITA, PROVINCIA, 'trm', getdate(), PARTITAIVA, CODNAZIONE, NUMALBOTR
--		FROM TABSPEDIZ WHERE CODICE = @codsped
			
			
	END
	
		-- appuntamenti
	--EXEC 		ITA_SP_UPDATE_DATEPOSIZIONAMENTO @idtesta, @idriga, @dataposizionamento, @codsped, 0, 1, @magstatom05
	EXECUTE dbo.ITA_SP_UPDATE_DATEPOSIZIONAMENTO @idtesta, @idriga, @dataposizionamento, @codsped, 0, 1, @datacarico, @dataconsegna, @user, @magstatom05

	
	-- note destinazioni diverse
	
	UPDATE DESTINAZIONIDIVERSE
	SET NOTE = @noteddc
	WHERE CODICE = @numdestdiversamerci AND CODCONTO = @codconto
	
	
	-- LOG
	INSERT INTO LOG_EXTRARIGHEDOCM05
	(
		IDTESTA,
		IDRIGA,
		UTENTEMODIFICA,
		DATAMODIFICA,
		UTENTE,
		MACHINE,
		ACTION
	)
	VALUES 
	(
		@idtesta,
		@idriga,
		@codsped,
		GETDATE(),
		@user,
		@machine,
		'AGGIORNAMENTO DA M05'
	)
	
	
	RETURN

END
GO

GRANT EXECUTE ON dbo.ITA_SP_UPDATE_DATISPEDIZIONE TO Metodo98
GO




IF OBJECT_ID ('dbo.ITA_SP_UPDATE_RAGGRUPPAMENTO') IS NOT NULL
	DROP PROCEDURE dbo.ITA_SP_UPDATE_RAGGRUPPAMENTO
GO

CREATE PROCEDURE [dbo].[ITA_SP_UPDATE_RAGGRUPPAMENTO]
(

@idtesta DECIMAL(10)
, @idriga DECIMAL(5)
, @raggruppamento VARCHAR(10)
, @user VARCHAR(255) = ''
)
AS

BEGIN

	SET NOCOUNT ON
	
	IF @idtesta > 0
	BEGIN
	

	
		-- aggiornamento dati extra
		UPDATE EXTRARIGHEDOC
		SET RAGGRUPPAMENTO = @raggruppamento, DATAMODIFICA = GETDATE(), UTENTEPOSIZIONAMENTO = @user
		WHERE IDTESTA = @idtesta AND idriga = @idriga
		
	END 	
	
	

	RETURN

END
GO

GRANT EXECUTE ON dbo.ITA_SP_UPDATE_RAGGRUPPAMENTO TO Metodo98
GO

