create FUNCTION [dbo].[GET_EXCEL_PORTAFOGLIOORDINI_ITA]
    (
       @DATAPOSIZIONAMENTO VARCHAR(10)
       , @SPEDIZIONIERE VARCHAR(50)
       
    )
RETURNS TABLE
AS RETURN
    ( 
		
	SELECT * FROM (
		SELECT 
			ARTICOLO,
			DESCRIZIONE,
			COLLI,
			IMBALLO,
			ADR,
			CLASSE,
			LOTTO,
			DESTINAZIONE,
			SPEDIZIONIERE,
			DATAPOSIZIONAMENTO,
			DOCUMENTO,
			codsped,
			idtesta,
			idriga,
			QTASPEDIBILE
		FROM EXCEL_PORTAFOGLIOORDINI_ITA 
		WHERE DATAPOSIZIONAMENTO = @DATAPOSIZIONAMENTO AND SPEDIZIONIERE = @SPEDIZIONIERE
		
		UNION
		
		SELECT 
			'ZZZZZZZZZZZZZZ' AS ARTICOLO,
			' ' AS DESCRIZIONE,
			0 AS COLLI,
			'' AS IMBALLO,
			'' AS ADR,
			'' AS CLASSE,
			'' AS LOTTO,
			DESTINAZIONE AS DESTINAZIONE,
			SPEDIZIONIERE AS SPEDIZIONIERE,
			DATAPOSIZIONAMENTO,
			'' AS DOCUMENTO,
			max(codsped) AS codsped,
			0 AS idtesta,
			0 AS idriga,
			0 AS QTASPEDIBILE
		FROM dbo.EXCEL_PORTAFOGLIOORDINI_ITA
		WHERE DATAPOSIZIONAMENTO = @DATAPOSIZIONAMENTO AND SPEDIZIONIERE = @SPEDIZIONIERE
		GROUP BY SPEDIZIONIERE, DATAPOSIZIONAMENTO, DESTINAZIONE
	
		UNION
		
		SELECT 
			'TOTALE ' AS ARTICOLO,
			'SPEDIBILE ' AS DESCRIZIONE,
			SUM(COLLI) AS COLLI,
			CAST(CAST(SUM(QTASPEDIBILE) AS INT) AS VARCHAR) + ' KG' AS IMBALLO,
			'' AS ADR,
			'' AS CLASSE,
			'' AS LOTTO,
			'ZZZZZZZZZZ' AS DESTINAZIONE,
			SPEDIZIONIERE AS SPEDIZIONIERE,
			DATAPOSIZIONAMENTO,
			'' AS DOCUMENTO,
			codsped,
			0 AS idtesta,
			0 AS idriga,
			0 AS QTASPEDIBILE
		FROM dbo.EXCEL_PORTAFOGLIOORDINI_ITA
		WHERE DATAPOSIZIONAMENTO = @DATAPOSIZIONAMENTO AND SPEDIZIONIERE = @SPEDIZIONIERE
		GROUP BY SPEDIZIONIERE, DATAPOSIZIONAMENTO, CODSPED
	) 
	CTE


)
GO

GRANT DELETE ON dbo.GET_EXCEL_PORTAFOGLIOORDINI_ITA TO Metodo98
GO
GRANT INSERT ON dbo.GET_EXCEL_PORTAFOGLIOORDINI_ITA TO Metodo98
GO
GRANT REFERENCES ON dbo.GET_EXCEL_PORTAFOGLIOORDINI_ITA TO Metodo98
GO
GRANT SELECT ON dbo.GET_EXCEL_PORTAFOGLIOORDINI_ITA TO Metodo98
GO
GRANT UPDATE ON dbo.GET_EXCEL_PORTAFOGLIOORDINI_ITA TO Metodo98
GO

SELECT * FROM dbo.GET_EXCEL_PORTAFOGLIOORDINI_ITA ('20170612', 'ARCO SPEDIZIONI SPA') ORDER BY SPEDIZIONIERE, DESTINAZIONE, ARTICOLO