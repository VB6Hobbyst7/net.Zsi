IF OBJECT_ID ('dbo.EXCEL_PORTAFOGLIOORDINI_COA') IS NOT NULL
	DROP VIEW dbo.EXCEL_PORTAFOGLIOORDINI_COA
GO

create view EXCEL_PORTAFOGLIOORDINI_COA as 

SELECT 
	RAGIONESOCIALE,
	DOCUMENTO,
	ARTICOLO,
	XLS_M12ITA_DESCRIZIONEART AS DESCRIZIONE,
	CAST(QTAGESTRES AS INT) AS QTAGESTRES,
	NRPEZZIIMBALLO,
	COLLISPEDIBILI AS COLLI,
	IMBALLO,
	DATACARICO,
	DATAPOSIZIONAMENTO,
	POSIZIONAMENTO,
 	XLS_M05_ESTERO_DISPONIBILITA AS DISPONIBILITA,
 	XLS_DESTINAZIONE AS DESTINAZIONE,
 	IDTESTA,
 	IDRIGA,
 	COLLISPEDIBILI,
 	XLS_CLASSEADR,
 	NRLOTTO, QTASPEDIBILE
	
	
FROM (
	SELECT 
		(CASE WHEN ACF.STATOBOLLE = 2 AND (CASE WHEN T.CODPAGAMENTO IN (SELECT CODICE FROM VISTA_PAGAMENTIANTICIPATI) THEN 1 ELSE 0 END) = 0 THEN '[BLOCCATO] ' 
	        WHEN ACF.STATOBOLLE = 2 AND (CASE WHEN T.CODPAGAMENTO IN (SELECT CODICE FROM VISTA_PAGAMENTIANTICIPATI) THEN 1 ELSE 0 END) = 1 THEN '[PAG. ANT.] ' 
        	ELSE '' END) + AC.DSCCONTO1 AS RAGIONESOCIALE
        , T.TIPODOC + '/' + CAST(T.ESERCIZIO AS VARCHAR) + '/' + RIGHT('000000' + CAST(T.NUMERODOC AS VARCHAR), 6) AS DOCUMENTO -- + '/' + CAST(R.POSIZIONE AS VARCHAR) AS DOCUMENTO 
        , T.NUMRIFDOC, ET.RIFCLI 
        , R.CODART AS ARTICOLO
        , (isnull((SELECT x.DSCART_ALT FROM VistaRelazioniCFVdaDocZSIM05 x WHERE x.PROGRESSIVO = t.progressivo AND x.IDRIGA = r.idriga), R.DESCRIZIONEART)  + '(' + ISNULL(AA.DESCRIZIONE, '')  + ')') AS DESCRIZIONE
        --, (R.DESCRIZIONEART + '(' + ISNULL(AA.DESCRIZIONE, '')  + ')') AS DESCRIZIONE
 		, I.DESCRIZIONE IMBALLO 
        , CAST(R.QTAGESTRES AS INT) AS QTAGESTRES
        , CAST(isnull(R.NRPEZZIIMBALLO, 0) AS INT) AS NRPEZZIIMBALLO
        , CAST(
        		(CASE WHEN ISNULL(R.NRPEZZIIMBALLO,0) = 0 THEN 0 
        				ELSE ceiling(R.QTAGESTRES/R.NRPEZZIIMBALLO) 
        				END)
         AS INT) FUSTI 
        , isnull(ER.NRLOTTO, '---') AS NRLOTTO
        , ISNULL(SD.RAGIONESOCIALE, '') AS SPEDIZIONIERE
        , (CASE WHEN ISNULL(ER.NOTECLI,'') <> '' THEN ER.NOTECLI ELSE NC.NOTE END) NOTECLI 
        , (CASE WHEN ISNULL(ER.NOTEART,'') <> '' THEN ER.NOTEART ELSE NA.NOTE END) NOTEART 
        , ER.POSIZIONAMENTO
        , isnull(z.QTACONFEZIONE, isnull(ER.QTASPEDIBILE, 0)) AS QTASPEDIBILE
        , CAST(isnull((CASE WHEN CAST(R.NRPEZZIIMBALLO AS INT) > 0 THEN R.QTAGESTRES/CAST(R.NRPEZZIIMBALLO AS INT) ELSE 0 END), 0) AS INT) AS COLLIDASPEDIRE
        , CAST(isnull((CASE WHEN CAST(R.NRPEZZIIMBALLO AS INT) > 0 THEN ER.QTASPEDIBILE/CAST(R.NRPEZZIIMBALLO AS INT) ELSE 0 END), 0) AS INT) AS COLLISPEDIBILI

        , '' AS TIPOPALLET
        , '' AS ETICHETTATURA
        , T.ESERCIZIO, T.TIPODOC, T.NUMERODOC, T.BIS, T.DATADOC 
        , T.PROGRESSIVO AS IDTESTA, R.IDRIGA 
        , T.CODCLIFOR
        , T.DATARIFDOC
        , I.CODICE CODIMBALLO
        --, isnull(isnull(ET.CODSPEDMANDATO, ACF.CODSPED), 0) AS CODSPED
        , isnull(ET.CODSPEDMANDATO, 0) AS CODSPED
        , R.UMGEST
        , isnull(ER.DATACARICO, R.DATACONSEGNA) AS DATACARICO
        , T.NUMDESTDIVERSAMERCI
        , R.ANNOTAZIONI
		, AC.DSCCONTO1 AS XLS_CLIENTE
        , (CASE WHEN ISNULL(T.RAGSOCDDM, '') = '' THEN 
        		AC.DSCCONTO1 + ' ' + AC.INDIRIZZO + ' ' + AC.LOCALITA + ' ' + AC.PROVINCIA 
        	ELSE
        		t.RAGSOCDDM + ' ' + t.INDIRIZZODDM + ' ' + t.LOCALITADDM + ' ' + t.PROVINCIADDM 
        	END) AS XLS_DESTINAZIONE
        , (CAST( 
        	CAST(
        		(CASE WHEN ISNULL(R.NRPEZZIIMBALLO,0) = 0 THEN 0 
        				ELSE ceiling(R.QTAGESTRES/R.NRPEZZIIMBALLO) 
        				END)
         	AS INT) 
         AS VARCHAR) + ' ' + I.DESCRIZIONE) AS XLS_TIPOIMBALLO
        , isnull(ER.NRLOTTO, '---') AS XLS_NRLOTTO
        , ISNULL(ARTADR.NUMONU, '') AS XLS_NUMONU
        , ISNULL(ARTADR.CLASSEADR, 'NO') AS XLS_CLASSEADR
        , ISNULL(SD.RAGIONESOCIALE, '') AS XLS_SPEDIZIONIERE
        , (CASE WHEN ISNULL(ER.NOTECLI,'') <> '' THEN ER.NOTECLI ELSE NC.NOTE END) + ' ' + R.ANNOTAZIONI AS XLS_NOTE
      , (CASE WHEN ISNULL(ER.NOTEART,'') <> '' THEN ER.NOTEART ELSE NA.NOTE END) XLS_NOTEART 
        , ER.NOTEMAG AS XLS_NOTEMAG
        , CAST(CAST((CASE WHEN ISNULL(ER.QTASPEDIBILE, 0) = 0 THEN R.QTAGESTRES ELSE ER.QTASPEDIBILE END) AS INT) AS VARCHAR)AS XLS_QTA
        , ER.DATAPOSIZIONAMENTO
        , row_number() OVER(PARTITION BY ER.DATAPOSIZIONAMENTO ORDER BY ER.DATAPOSIZIONAMENTO) AS RN
        , (isnull((SELECT x.DSCART_ALT FROM VistaRelazioniCFVdaDocZSIM05 x WHERE x.PROGRESSIVO = t.progressivo AND x.IDRIGA = r.idriga), R.DESCRIZIONEART)  + ' (' + ISNULL(AA.DESCRIZIONE, '')  + ')' + 
        ' DOC. ' + T.TIPODOC + '/' + CAST(T.ESERCIZIO AS VARCHAR) + '/' + CAST(T.NUMERODOC AS VARCHAR) + ' - ' + T.NUMRIFDOC) AS XLS_DESCRIZIONE
        , (SELECT TOP 1 TABPORTO.DESCRIZIONE FROM TABPORTO WHERE TABPORTO.CODICE = T.PORTO) AS XLS_PORTO
		, isnull((SELECT TOP 1 x.disponibilita FROM ZSI_DISPONIBILITAM05 x WHERE x.CODCLIFOR = t.codclifor AND x.CODART = r.codart AND x.CODIMBALLO = R.CODIMBALLO), 0) AS XLS_M05_ESTERO_DISPONIBILITA        
		--, (CASE WHEN T.CODPAGAMENTO IN (SELECT CODICE FROM VISTA_PAGAMENTIANTICIPATI) THEN 1 ELSE 0 END)
		, ISNULL(T.RAGSOCDDM, '') AS XLS_DESTINAZIONERAGSOC        
        , '''' + convert(VARCHAR, ISNULL(ER.DATAPOSIZIONAMENTO, 
        (
        	CASE WHEN (SELECT COUNT(*) FROM TABPORTO WHERE TABPORTO.CODICE = T.PORTO AND LEFT(tabporto.DESCRIZIONE,3) = 'EXW') = 1 
        	THEN ER.DATACARICO 
        	ELSE '21000101' END)
        ), 103) AS XLS_DATAPOSIZIONAMENTO
        , R.DESCRIZIONEART AS XLS_M12ITA_DESCRIZIONEART
        , (CASE WHEN ISNULL(T.RAGSOCDDM, '') = '' THEN 
        		AC.DSCCONTO1 + ' - ' + AC.LOCALITA + ' (' + AC.PROVINCIA  + ')'
        	ELSE
        		t.RAGSOCDDM + ' - ' + t.LOCALITADDM + ' (' + t.PROVINCIADDM  + ')'
        	END) AS XLS_M12ITADESTINAZIONE        
        
FROM TESTEDOCUMENTI T WITH (NOLOCK) JOIN EXTRATESTEDOC ET WITH (NOLOCK) ON T.PROGRESSIVO = ET.IDTESTA 
JOIN RIGHEDOCUMENTI R WITH (NOLOCK) ON T.PROGRESSIVO = R.IDTESTA 
JOIN ANAGRAFICACF AC WITH (NOLOCK) ON AC.CODCONTO = T.CODCLIFOR 
JOIN EXTRACLIENTI WITH (NOLOCK) ON EXTRACLIENTI.CODCONTO = AC.CODCONTO
JOIN ANAGRAFICAARTICOLI AA WITH (NOLOCK) ON AA.CODICE = R.CODART 
JOIN EXTRARIGHEDOC ER WITH (NOLOCK) ON ER.IDTESTA = R.IDTESTA AND ER.IDRIGA = R.IDRIGA 
JOIN ANAGRAFICARISERVATICF ACF WITH (NOLOCK) ON ACF.ESERCIZIO = YEAR(GETDATE()) AND ACF.CODCONTO = T.CODCLIFOR 
LEFT OUTER JOIN ZSI_CONFEZSPEDIBILE z WITH (NOLOCK) ON Z.PROGRESSIVO = r.IDTESTA AND z.idriga = r.IDRIGA
LEFT OUTER JOIN TAB_ARTICOLIADR ARTADR WITH (NOLOCK) ON ARTADR.CODART = R.CODART
LEFT OUTER JOIN TABIMBALLI I WITH (NOLOCK) ON R.CODIMBALLO = I.CODICE 
LEFT OUTER JOIN ZSI_NOTECLI NC WITH (NOLOCK) ON T.CODCLIFOR = NC.CODCLI AND (T.NUMDESTDIVERSAMERCI = NC.CODDEST OR (T.NUMDESTDIVERSAMERCI = 0 AND NC.CODDEST = -1) OR (T.NUMDESTDIVERSAMERCI <> 0 AND NOT EXISTS(SELECT 1 FROM ZSI_NOTECLI Z WHERE Z.CODCLI = T.CODCLIFOR AND Z.CODDEST = T.NUMDESTDIVERSAMERCI) AND NC.CODDEST = -1) ) 
LEFT OUTER JOIN ZSI_NOTEART NA WITH (NOLOCK) ON T.CODCLIFOR = NA.CODCLI AND R.CODART = NA.CODART 
	 AND (T.NUMDESTDIVERSAMERCI = NA.CODDEST 
	 OR (T.NUMDESTDIVERSAMERCI = 0 AND NA.CODDEST = -1) 
	 OR (T.NUMDESTDIVERSAMERCI <> 0 AND NOT EXISTS(SELECT 1 FROM ZSI_NOTEART Z WHERE Z.CODCLI = T.CODCLIFOR AND Z.CODDEST = T.NUMDESTDIVERSAMERCI) AND NA.CODDEST = -1) 
	 )
LEFT OUTER JOIN TABSPEDIZ SD WITH (NOLOCK) ON ET.CODSPEDMANDATO = SD.CODICE
wHERE 
	t.tipodoc = 'OCE' AND 
	R.CODART <> '' AND
	--R.QTAGESTRES > 0 AND 
	t.esercizio >= year(getdate())-2
	--AND t.numerodoc = 1449
	AND R.CODIMBALLO NOT IN (100, 101)

) CTE
WHERE cte.collispedibili > 0
GO

GRANT DELETE ON dbo.EXCEL_PORTAFOGLIOORDINI_COA TO Metodo98
GO
GRANT INSERT ON dbo.EXCEL_PORTAFOGLIOORDINI_COA TO Metodo98
GO
GRANT REFERENCES ON dbo.EXCEL_PORTAFOGLIOORDINI_COA TO Metodo98
GO
GRANT SELECT ON dbo.EXCEL_PORTAFOGLIOORDINI_COA TO Metodo98
GO
GRANT UPDATE ON dbo.EXCEL_PORTAFOGLIOORDINI_COA TO Metodo98
GO



SELECT * FROM EXCEL_PORTAFOGLIOORDINI_COA WHERE IDTESTA = 449596





IF OBJECT_ID ('dbo.GET_EXCEL_PORTAFOGLIOORDINI_COA') IS NOT NULL
	DROP FUNCTION dbo.GET_EXCEL_PORTAFOGLIOORDINI_COA
GO

CREATE FUNCTION [dbo].[GET_EXCEL_PORTAFOGLIOORDINI_COA]
    (
       @DATAPOSIZIONAMENTO VARCHAR(10)
    )
RETURNS TABLE
AS RETURN
    ( 
		
	SELECT ARTICOLO, DESCRIZIONE, RAGIONESOCIALE AS CLIENTE
	, COLLI
	, IMBALLO
	, ADR
	, LOTTO
	, DOCUMENTO
	, DESTINAZIONE
	, DATAPOSIZIONAMENTO
	, IDTESTA
	, IDRIGA
	, QTASPEDIBILE
	FROM (
		SELECT 
			ARTICOLO,
			DESCRIZIONE, 
			EXCEL_PORTAFOGLIOORDINI.COLLISPEDIBILI AS COLLI,
			IMBALLO,
			EXCEL_PORTAFOGLIOORDINI.XLS_CLASSEADR AS ADR,
			EXCEL_PORTAFOGLIOORDINI.NRLOTTO AS LOTTO,
			DESTINAZIONE,
 			DATAPOSIZIONAMENTO,
			DOCUMENTO,
			idtesta,
			idriga,
			QTASPEDIBILE,
			RAGIONESOCIALE
		FROM EXCEL_PORTAFOGLIOORDINI
		WHERE DATAPOSIZIONAMENTO = @DATAPOSIZIONAMENTO
		AND TIPODOC = 'OCE' AND CODIMBALLO NOT IN (100, 101)
		
		UNION
		
		SELECT 
			'ZZZZZZZZZZZZZZ' AS ARTICOLO,
			' ' AS DESCRIZIONE,
			0 AS COLLI,
			'' AS IMBALLO,
			'' AS ADR,
			'' AS LOTTO,
			'' AS DESTINAZIONE,
			DATAPOSIZIONAMENTO,
			'' AS DOCUMENTO,
			0 AS idtesta,
			0 AS idriga,
			0 AS QTASPEDIBILE,
			RAGIONESOCIALE
		FROM dbo.EXCEL_PORTAFOGLIOORDINI
		WHERE DATAPOSIZIONAMENTO = @DATAPOSIZIONAMENTO
		AND TIPODOC = 'OCE' AND CODIMBALLO NOT IN (100, 101)
		GROUP BY DATAPOSIZIONAMENTO, RAGIONESOCIALE
	
		UNION
		
		SELECT 
			'TOTALE ' AS ARTICOLO,
			'SPEDIBILE ' AS DESCRIZIONE,
			SUM(EXCEL_PORTAFOGLIOORDINI.COLLISPEDIBILI) AS COLLI,
			CAST(CAST(SUM(QTASPEDIBILE) AS INT) AS VARCHAR) + ' KG' AS IMBALLO,
			'' AS ADR,
			'' AS LOTTO,
			'ZZZZZZZZZZ' AS DESTINAZIONE,
			DATAPOSIZIONAMENTO,
			'' AS DOCUMENTO,
			0 AS idtesta,
			0 AS idriga,
			0 AS QTASPEDIBILE,
			RAGIONESOCIALE
		FROM dbo.EXCEL_PORTAFOGLIOORDINI
		WHERE DATAPOSIZIONAMENTO = @DATAPOSIZIONAMENTO 
		AND TIPODOC = 'OCE' AND CODIMBALLO NOT IN (100, 101)
		GROUP BY DATAPOSIZIONAMENTO, RAGIONESOCIALE
	) 
	CTE


)
GO

GRANT DELETE ON dbo.GET_EXCEL_PORTAFOGLIOORDINI_COA TO Metodo98
GO
GRANT INSERT ON dbo.GET_EXCEL_PORTAFOGLIOORDINI_COA TO Metodo98
GO
GRANT REFERENCES ON dbo.GET_EXCEL_PORTAFOGLIOORDINI_COA TO Metodo98
GO
GRANT SELECT ON dbo.GET_EXCEL_PORTAFOGLIOORDINI_COA TO Metodo98
GO
GRANT UPDATE ON dbo.GET_EXCEL_PORTAFOGLIOORDINI_COA TO Metodo98
GO


IF OBJECT_ID ('dbo.EXCEL_PORTAFOGLIOORDINI_APPOINTMENTS') IS NOT NULL
	DROP VIEW dbo.EXCEL_PORTAFOGLIOORDINI_APPOINTMENTS
GO

create view EXCEL_PORTAFOGLIOORDINI_APPOINTMENTS as 


SELECT 
e.DESCRIZIONE as Summary

--, rn
--, dateadd(N, (8 * 60) + (rn * 30), DATAPOSIZIONAMENTO) AS Start
--, dateadd(N, (8 * 60) + ((rn + 1) * 30), DATAPOSIZIONAMENTO) AS [End]
, '' AS RecurrenceRule
, 0 as MasterEventId
, LEFT(' Cliente: ' + e.RAGIONESOCIALE  + ' Ordine: ' + CAST(e.NUMERODOC AS VARCHAR) + e.DESTINAZIONE, 255) AS Location
, e.DESCRIZIONE 
	+ ' Cliente: ' + e.RAGIONESOCIALE 
	+ ' Q.tà: ' + CAST(CAST(XLS_QTA AS INT) AS VARCHAR) 
	+ ' [' + IMBALLO + '] Lotto: ' + NRLOTTO 
	+ ' Ordine: ' + CAST(e.NUMERODOC AS VARCHAR)
	+ ' Fusti/Cubi: ' + CAST(e.NRPEZZIIMBALLO AS VARCHAR)
	
	AS Description
--, (CASE WHEN e.MAGSTATORIGA = 1 THEN 4 
--WHEN e.MAGSTATORIGA = 2 THEN 11
--WHEN e.MAGSTATORIGA = 3 THEN 2
--ELSE 1 END) AS BackgroundId
, (CASE WHEN E.TIPODOC = 'OCE' THEN 7 ELSE 1 END) AS BackgroundId
, CAST(e.idtesta AS VARCHAR) + '|' + CAST(e.idriga AS VARCHAR) AS MKEY
, e.IDTESTA, e.idriga
, e.DATACARICO
, e.DATAPOSIZIONAMENTO
, (CASE WHEN IMBALLO = 'CISTERNA' THEN 'C' ELSE 'I' END) AS TIPOIMBALLO
, (CASE WHEN E.TIPODOC = 'OCE' THEN 'E' ELSE 'I' END) AS TIPOORDINE
, E.RAGIONESOCIALE
FROM EXCEL_PORTAFOGLIOORDINI e
GO

GRANT DELETE ON dbo.EXCEL_PORTAFOGLIOORDINI_APPOINTMENTS TO Metodo98
GO
GRANT INSERT ON dbo.EXCEL_PORTAFOGLIOORDINI_APPOINTMENTS TO Metodo98
GO
GRANT REFERENCES ON dbo.EXCEL_PORTAFOGLIOORDINI_APPOINTMENTS TO Metodo98
GO
GRANT SELECT ON dbo.EXCEL_PORTAFOGLIOORDINI_APPOINTMENTS TO Metodo98
GO
GRANT UPDATE ON dbo.EXCEL_PORTAFOGLIOORDINI_APPOINTMENTS TO Metodo98
GO



IF OBJECT_ID ('dbo.fn_GetLOTTIM05') IS NOT NULL
	DROP FUNCTION dbo.fn_GetLOTTIM05
GO

create function [dbo].[fn_GetLOTTIM05](@IdTesta decimal(10, 0), @IdRiga decimal(5, 0)) returns varchar(8000) as begin
	declare @Str varchar(1000)
	
	set @Str = ''
	
	select @Str = @Str + (case @Str when '' then '' else '-' end) + cast(r.LOTTO as varchar) + ' (' + CAST(CAST(max(r.QTACONFEZIONE) AS INT) AS VARCHAR) + ')'
	from ZSI_CONFEZSPEDIBILE R 
	WHERE R.PROGRESSIVO = @IdTesta AND R.IDRIGA = @IdRiga
	AND patindex('%---%', r.lotto) = 0 and r.idtestaddt = 0
	group by r.LOTTO

	IF @str = ''
	BEGIN
		-- imposto a 0 altrimenti la pubblicazione va in errore 
		SET @str = ''
	END

	return @Str
end
GO

GRANT EXECUTE ON dbo.fn_GetLOTTIM05 TO Metodo98
GO
GRANT REFERENCES ON dbo.fn_GetLOTTIM05 TO Metodo98
GO


