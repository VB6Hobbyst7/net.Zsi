IF OBJECT_ID ('dbo.EXCEL_PORTAFOGLIOORDINI_APPOINTMENTS') IS NOT NULL
	DROP VIEW dbo.EXCEL_PORTAFOGLIOORDINI_APPOINTMENTS
GO

create view EXCEL_PORTAFOGLIOORDINI_APPOINTMENTS as 


SELECT 
(CASE WHEN e.MAGSTATOM05 < 2 THEN '[P] ' ELSE '' END) + e.DESCRIZIONE as Summary
--, rn
--, dateadd(N, (8 * 60) + (rn * 30), DATAPOSIZIONAMENTO) AS Start
--, dateadd(N, (8 * 60) + ((rn + 1) * 30), DATAPOSIZIONAMENTO) AS [End]
, '' AS RecurrenceRule
, 0 as MasterEventId
, LEFT(' Cliente: ' + e.RAGIONESOCIALE  + ' Ordine: ' + CAST(e.NUMERODOC AS VARCHAR) + e.DESTINAZIONE, 255) AS Location
, e.DESCRIZIONE 
	+ ' Cliente: ' + e.RAGIONESOCIALE 
	+ ' Q.tà: ' + CAST(CAST(XLS_QTA AS INT) AS VARCHAR) 
	+ ' [' + IMBALLO + '] Lotto: ' + NRLOTTO 
	+ ' Ordine: ' + CAST(e.NUMERODOC AS VARCHAR)
	+ ' Fusti/Cubi: ' + CAST(e.NRPEZZIIMBALLO AS VARCHAR)
	
	AS Description
--, (CASE WHEN e.MAGSTATORIGA = 1 THEN 4 
--WHEN e.MAGSTATORIGA = 2 THEN 11
--WHEN e.MAGSTATORIGA = 3 THEN 2
--ELSE 1 END) AS BackgroundId
, (CASE WHEN E.TIPODOC = 'OCE' THEN 7 ELSE 1 END) AS BackgroundId
, CAST(e.idtesta AS VARCHAR) + '|' + CAST(e.idriga AS VARCHAR) AS MKEY
, e.IDTESTA, e.idriga
, e.DATACARICO
, e.DATAPOSIZIONAMENTO
, (CASE WHEN IMBALLO = 'CISTERNA' THEN 'C' ELSE 'I' END) AS TIPOIMBALLO
, (CASE WHEN E.TIPODOC = 'OCE' THEN 'E' ELSE 'I' END) AS TIPOORDINE
, E.RAGIONESOCIALE
FROM EXCEL_PORTAFOGLIOORDINI e
GO

GRANT DELETE ON dbo.EXCEL_PORTAFOGLIOORDINI_APPOINTMENTS TO Metodo98
GO
GRANT INSERT ON dbo.EXCEL_PORTAFOGLIOORDINI_APPOINTMENTS TO Metodo98
GO
GRANT REFERENCES ON dbo.EXCEL_PORTAFOGLIOORDINI_APPOINTMENTS TO Metodo98
GO
GRANT SELECT ON dbo.EXCEL_PORTAFOGLIOORDINI_APPOINTMENTS TO Metodo98
GO
GRANT UPDATE ON dbo.EXCEL_PORTAFOGLIOORDINI_APPOINTMENTS TO Metodo98
GO





IF OBJECT_ID ('dbo.ITA_SP_UPDATE_LOTTORIGA') IS NOT NULL
	DROP PROCEDURE dbo.ITA_SP_UPDATE_LOTTORIGA
GO

CREATE PROCEDURE [dbo].[ITA_SP_UPDATE_LOTTORIGA]
(

@idtesta DECIMAL(10)
, @idriga DECIMAL(5)
, @nrlotto AS VARCHAR(50)
, @user AS VARCHAR(255)
, @machine AS VARCHAR(255)
)


AS

BEGIN

	SET NOCOUNT ON

	
	
	-- aggiornamento dati extra
	UPDATE EXTRARIGHEDOC
	SET NRLOTTO = @nrlotto
	WHERE IDTESTA = @idtesta AND idriga = @idriga
	
	
	-- LOG
	INSERT INTO LOG_EXTRARIGHEDOCM05
	(
		IDTESTA,
		IDRIGA,
		UTENTEMODIFICA,
		DATAMODIFICA,
		UTENTE,
		MACHINE,
		ACTION
	)
	VALUES 
	(
		@idtesta,
		@idriga,
		@user,
		GETDATE(),
		@user,
		@machine,
		'AGGIORNAMENTO LOTTO DA M05'
	)
	
	
					
	RETURN

END
GO

GRANT EXECUTE ON dbo.ITA_SP_UPDATE_LOTTORIGA TO Metodo98
GO
